

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Free Energy Calculations &mdash; Ensembler beta documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Documentation" href="../_source/modules.html" />
    <link rel="prev" title="Enhanced Sampling Simulations" href="Example_EnhancedSampling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Ensembler
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Welcome to Ensembler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Example_ConveyorBelt.html">Conveyor Belt Thermodynamic Integration with Ensembler</a></li>
<li class="toctree-l2"><a class="reference internal" href="Example_EDS.html">EDS Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Example_EnhancedSampling.html">Enhanced Sampling Simulations</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Free Energy Calculations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#References:">References:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Benchmarking-parameters">Benchmarking parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#The-Test-System:-Setting-up-a-System">The Test System: Setting up a System</a></li>
<li class="toctree-l3"><a class="reference internal" href="#The-Analyctical-Solution:-Nice-if-there-is-one">The Analyctical Solution: Nice if there is one</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Free-Energy-Pertubation---BAR/Zwanzig:-a-simplistic-start">Free Energy Pertubation - BAR/Zwanzig: a simplistic start</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Sampling">Sampling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Analysis">Analysis</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Coupling-Methods">Coupling Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#\lambda---Coupling"><span class="math notranslate nohighlight">\(\lambda\)</span> - Coupling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Build-System">Build System</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Sampling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#EXP/FEP-with-multiple-lambda-windows:">EXP/FEP with multiple lambda windows:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#State-Coupled---Enveloping-Distribution-Sampling-(EDS)">State Coupled - Enveloping Distribution Sampling (EDS)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Build System</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Sampling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">Analysis</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Hybrid-Methods---\lambda-EDS">Hybrid Methods - <span class="math notranslate nohighlight">\(\lambda\)</span>-EDS</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">Build System</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Simulate">Simulate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Analysis</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Enhanced-Sampling-with-system-Coupling">Enhanced Sampling with system Coupling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Conveyor-Belt-TI">Conveyor Belt TI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#RE-EDS">RE-EDS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Final-Results">Final Results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../_source/modules.html">Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ensembler</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Examples</a> &raquo;</li>
        
      <li>Free Energy Calculations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Examples/Example_FreeEnergyCalculationSimulation.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Free-Energy-Calculations">
<h1>Free Energy Calculations<a class="headerlink" href="#Free-Energy-Calculations" title="Permalink to this headline">¶</a></h1>
<p>In this Notebook, we want to give a short glimpse on Free Energy Calculations with Ensembler.</p>
<p>Free energies are an very important topic in computational chemistry. As they are fundamental to thermodynamics and can give a lot of information for different changes to a system. Generally we can destinguish three types of free energies: thermodynamic, conformational and alchemical. The thermodynamic category is a free energy difference related to a change of an thermodynamic property of the system. The conformational free energy difference can be used to describe a conformational change of a
molecule (phase space areas) and the alchemical free energy is describing a change in the chemical space of the molecule (e.g.: methylation).</p>
<p>To calculate a free energy can be very tricky. A challenge might be sampling convergence due to high energy barriers or entropy differences.</p>
<p>To be able to estimate the influence of a chemical change, one needs to calculate the free energies of both so called states.</p>
<p>Here we calculate the Free Energy as:</p>
<p><span class="math notranslate nohighlight">\(F_i = V_i - T_i S_i = -\beta \ln(Z_i)\)</span></p>
<p>Or we can use the statistical approach:</p>
<p><span class="math notranslate nohighlight">\(F_i(t) = -\frac{1}{\beta} \ln(\langle e^{-\beta H_i(t)}\rangle_i)\)</span></p>
<p>With the Gibbs Free Energy of state i and state J we can get the Free Energy Difference of the change.</p>
<p><span class="math notranslate nohighlight">\(\Delta F_{ij} = F_j - F_i = -\beta \ln(\frac{Z_i}{Z_j})\)</span></p>
<p>This allows us to estimate the influence of the change.</p>
<p>A free energy Calculation can be described contains three parts: * The System: Normally these contian multiple states. * The Sampling Method: The way how the Free Energy landscape will be integrated. * The Free Energy Estimator: The way, the free energy will be derived from the simulation.</p>
<p>In this notebook we will cover following methods: * Free Energy Pertubation * Zwanzig * BAR * linear coupling * FEP with 10 <span class="math notranslate nohighlight">\(\lambda\)</span>-points * TI with 10 <span class="math notranslate nohighlight">\(\lambda\)</span>-points * exponential coupling * EDS * hybrid coupling * <span class="math notranslate nohighlight">\(\lambda\)</span>-EDS * Enhanced Sampling methods: * Conveyor Belt * RE-EDS</p>
<div class="section" id="References:">
<h2>References:<a class="headerlink" href="#References:" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A good Book: Molecular Modelling Principles and Applications A. R. Leach</p></li>
<li><p>A good page to learn about free energies: <a class="reference external" href="http://www.alchemistry.org">http://www.alchemistry.org</a></p></li>
<li><p>Thesis: Development and Application of Free-energy Calcuation Methods based on Molecular Dynamics Simulations, D. F. Hahn, Diss. ETH NO. 25914</p></li>
</ul>
<p>Maintainers: [&#64;SchroederB](<a class="reference external" href="https://https://github.com/SchroederB">https://https://github.com/SchroederB</a>), [&#64;linkerst](<a class="reference external" href="https://https://github.com/linkerst">https://https://github.com/linkerst</a>), [&#64;dfhahn](<a class="reference external" href="https://https://github.com/dfhahn">https://https://github.com/dfhahn</a>)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Here some imports:</span>

<span class="c1">##System Path</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/..&quot;</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="c1">##basics</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1">##Ensembler</span>
<span class="kn">from</span> <span class="nn">ensembler.analysis.freeEnergyCalculation</span> <span class="kn">import</span> <span class="n">zwanzigEquation</span><span class="p">,</span> <span class="n">threeStateZwanzig</span><span class="p">,</span> <span class="n">bennetAcceptanceRatio</span>

<span class="kn">from</span> <span class="nn">ensembler.potentials</span> <span class="kn">import</span> <span class="n">OneD</span> <span class="k">as</span> <span class="n">pot</span>
<span class="kn">from</span> <span class="nn">ensembler.samplers.stochastic</span> <span class="kn">import</span> <span class="n">metropolisMonteCarloIntegrator</span>
<span class="kn">from</span> <span class="nn">ensembler.system.basic_system</span> <span class="kn">import</span> <span class="n">system</span>
<span class="kn">from</span> <span class="nn">ensembler.system.perturbed_system</span> <span class="kn">import</span> <span class="n">perturbedSystem</span>
<span class="kn">from</span> <span class="nn">ensembler.system.eds_system</span> <span class="kn">import</span> <span class="n">edsSystem</span>

<span class="c1">#Enhanced sampling methods</span>
<span class="kn">from</span> <span class="nn">ensembler.ensemble</span> <span class="kn">import</span> <span class="n">replica_exchange</span>
<span class="kn">from</span> <span class="nn">ensembler.ensemble</span> <span class="kn">import</span> <span class="n">replicas_dynamic_parameters</span> <span class="k">as</span> <span class="n">cvb</span>


<span class="kn">from</span> <span class="nn">ensembler.visualisation.plotSimulations</span> <span class="kn">import</span> <span class="n">oneD_simulation_analysis_plot</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">ensembler.visualisation</span> <span class="kn">import</span> <span class="n">style</span>
<span class="kn">from</span> <span class="nn">ensembler.visualisation</span> <span class="kn">import</span> <span class="n">plot_layout_settings</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">plot_layout_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Benchmarking-parameters">
<h2>Benchmarking parameters<a class="headerlink" href="#Benchmarking-parameters" title="Permalink to this headline">¶</a></h2>
<p>Here we define some parameters that allow us an easier comparison of the different methods.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">steps</span> <span class="o">=</span> <span class="n">simulation_steps_total_per_approach</span> <span class="o">=</span> <span class="mi">100</span><span class="c1">#00 #more steps better free energies, but if you just want to try 1000 ist quite fast.</span>
<span class="n">equilibration_steps</span> <span class="o">=</span> <span class="n">simulation_steps_total_per_approach</span><span class="o">//</span><span class="mi">10</span>

<span class="n">space_range</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="c1">#This defines our one dimensional coordinate space</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># for the metropolis criterion of MMC sampler</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">metropolisMonteCarloIntegrator</span><span class="p">(</span><span class="n">step_size_coefficient</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># With this algorithm wer are going to sample the potentials</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="The-Test-System:-Setting-up-a-System">
<h2>The Test System: Setting up a System<a class="headerlink" href="#The-Test-System:-Setting-up-a-System" title="Permalink to this headline">¶</a></h2>
<p>In the follwoing a test system is setup, for the Free Energy Calculations. For this Notebook, we want to keep it simple. Therefore two 1D-Harmonic Oscillators with different shifted minima and force constants shall be perfect for us. These two harmonic oscillators could for example describe the difference of two bonds types.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Build System</span>
<span class="c1">#System Parameters:</span>
<span class="n">yoff1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">xoff1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">force_constant</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">entropic_difference</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">potential_difference</span> <span class="o">=</span> <span class="n">yoff2</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">phase_space_distance</span> <span class="o">=</span> <span class="n">xoff2</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1">#State Potentials</span>
<span class="n">V_A</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">harmonicOscillatorPotential</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k1</span><span class="p">,</span> <span class="n">x_shift</span><span class="o">=</span><span class="n">xoff1</span><span class="p">,</span> <span class="n">y_shift</span><span class="o">=</span><span class="n">yoff1</span><span class="p">)</span>
<span class="n">V_B</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">harmonicOscillatorPotential</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k2</span><span class="p">,</span> <span class="n">x_shift</span><span class="o">=</span><span class="n">xoff2</span><span class="p">,</span> <span class="n">y_shift</span><span class="o">=</span><span class="n">yoff2</span><span class="p">)</span>

<span class="c1">#Visualize</span>
<span class="kn">from</span> <span class="nn">ensembler.visualisation.plotPotentials</span> <span class="kn">import</span> <span class="n">multiState_overlays</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multiState_overlays</span><span class="p">([</span><span class="n">V_A</span><span class="p">,</span><span class="n">V_B</span><span class="p">])</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_5_0.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_5_0.png" />
</div>
</div>
</div>
<div class="section" id="The-Analyctical-Solution:-Nice-if-there-is-one">
<h2>The Analyctical Solution: Nice if there is one<a class="headerlink" href="#The-Analyctical-Solution:-Nice-if-there-is-one" title="Permalink to this headline">¶</a></h2>
<p>The Analytical solution for our problem can be calculated from the free energy of harmonic oscillators using</p>
<p><span class="math notranslate nohighlight">\(F_i = V_i - \frac{1}{2*\beta} log(\sqrt{\frac{2 \pi}{k_i \beta}})\)</span>.</p>
<p>As we know all parameters of the harmonic oscillators, we simply can calculate <span class="math notranslate nohighlight">\(F_i\)</span> and <span class="math notranslate nohighlight">\(F_j\)</span>. The difference of both quantities then results in the final free energy difference:</p>
<p><span class="math notranslate nohighlight">\(\Delta F_{ij} = F_j - F_i\)</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Analytical Solution</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># beta is in kT</span>

<span class="n">F_A</span> <span class="o">=</span> <span class="n">yoff1</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">beta</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k1</span><span class="o">*</span><span class="n">beta</span><span class="p">)))</span>
<span class="n">F_B</span> <span class="o">=</span> <span class="n">yoff2</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">beta</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k2</span><span class="o">*</span><span class="n">beta</span><span class="p">)))</span>
<span class="n">dF_AB_expected</span> <span class="o">=</span> <span class="n">F_B</span><span class="o">-</span><span class="n">F_A</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;expected dF: &quot;</span><span class="p">,</span> <span class="n">dF_AB_expected</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
expected dF:  1.2746530721670273
</pre></div></div>
</div>
<p>For this toy example it was easy to calculate the free energy difference. But there is not always an analytical solution our problem. As the functional of a problem gets more complex we can not rely on an analytical solution anymore. In the following we are going to discuss some methods, that can be used in cases like this.</p>
</div>
<div class="section" id="Free-Energy-Pertubation---BAR/Zwanzig:-a-simplistic-start">
<h2>Free Energy Pertubation - BAR/Zwanzig: a simplistic start<a class="headerlink" href="#Free-Energy-Pertubation---BAR/Zwanzig:-a-simplistic-start" title="Permalink to this headline">¶</a></h2>
<p>The journey through the free energy method landscape is started with a simple start; The Free Energy Pertubation method. As we now assume to not know the analytical solution, we could for example use one state and simulate it, to explore its potential landscape. If the phase space overlap of both states is high, we could sample all the important information for both states, from this one simulation.</p>
<div class="section" id="Sampling">
<h3>Sampling<a class="headerlink" href="#Sampling" title="Permalink to this headline">¶</a></h3>
<p>Now we build first the two systems and run the simulations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Simulate the two states:</span>
<span class="c1">##Build Systems</span>
<span class="n">systemA</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">V_A</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
<span class="n">systemB</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">V_B</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

<span class="c1">##Simulate:</span>
<span class="n">systemA</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
<span class="n">stateA_traj</span> <span class="o">=</span> <span class="n">systemA</span><span class="o">.</span><span class="n">trajectory</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">oneD_simulation_analysis_plot</span><span class="p">(</span><span class="n">systemA</span><span class="p">,</span> <span class="n">limits_coordinate_space</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 5046.75it/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_10_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_10_1.png" />
</div>
</div>
</div>
<div class="section" id="Analysis">
<h3>Analysis<a class="headerlink" href="#Analysis" title="Permalink to this headline">¶</a></h3>
<p>After simulating state A, the potential energies for state B can be calculated using our potential fuction.</p>
<div class="section" id="Zwanzig-Equation">
<h4>Zwanzig Equation<a class="headerlink" href="#Zwanzig-Equation" title="Permalink to this headline">¶</a></h4>
<p>The Zwanzig equation is calculating the free energy difference of two states (A and B) sampled as an ensemble of one of the states (here A). The difference is boltzman-reweighted to increase the weight on the likely/favourable configurations.</p>
<p><span class="math notranslate nohighlight">\(dF_{ij_{Zwanzig}}(V_i, V_j) = - \beta \ln(\langle e^{-\beta(V_j-V_i)} \rangle_i )\)</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">VA_sampled_energies</span><span class="o">=</span><span class="n">stateA_traj</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">VB_sampled_energies</span><span class="o">=</span><span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateA_traj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:])</span>

<span class="n">zwanz</span> <span class="o">=</span> <span class="n">zwanzigEquation</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dF_AB_zwanzig</span> <span class="o">=</span> <span class="n">zwanz</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">Vi</span><span class="o">=</span><span class="n">VA_sampled_energies</span><span class="p">,</span> <span class="n">Vj</span><span class="o">=</span><span class="n">VB_sampled_energies</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_expected</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Zwanzig Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_zwanzig</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Difference:&quot;</span><span class="p">,</span> <span class="n">dF_AB_zwanzig</span> <span class="o">-</span> <span class="n">dF_AB_expected</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Expected Result:  1.2746530721670273
Zwanzig Result:  -1.0673475731663553

Difference: -2.342000645333383
</pre></div></div>
</div>
</div>
<div class="section" id="Bennet-Acceptance-Ratio-(BAR)">
<h4>Bennet Acceptance Ratio (BAR)<a class="headerlink" href="#Bennet-Acceptance-Ratio-(BAR)" title="Permalink to this headline">¶</a></h4>
<p>BAR requires one simulation of each state, to calculate the optimal path between both states. This is done in an iterative fashion. Usually BAR tends to give more accurate results than the Zwanzig approach.</p>
<p>Equation: <span class="math notranslate nohighlight">\(dF_{ij_{BAR}}(V_i, V_j) = \ln(\frac{\langle f(V_i-Vj+C) \rangle_j}{\langle f(V_j-V_i-C) \rangle_i}) + C - ln(\frac{n_1}{n_0})\)</span></p>
<p>with f as fermi function: - <span class="math notranslate nohighlight">\(f(x) = \frac{1}{1+e^{-\beta x}}\)</span></p>
<p><span class="math notranslate nohighlight">\(dF_{ij_{BAR}}\)</span> is calculated iterativley with <span class="math notranslate nohighlight">\(ddF_{ij_{BAR}}(V_i, V_j)\)</span>, till convergence</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Simulate the two states:</span>
<span class="c1">##Build Systems</span>

<span class="n">systemA</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">V_A</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
<span class="n">systemB</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">V_B</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

<span class="c1">##Simulate:</span>
<span class="n">systemA</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">withdraw_traj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_system</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">stateA_traj</span> <span class="o">=</span> <span class="n">systemA</span><span class="o">.</span><span class="n">trajectory</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">oneD_simulation_analysis_plot</span><span class="p">(</span><span class="n">systemA</span><span class="p">,</span> <span class="n">limits_coordinate_space</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">systemB</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">withdraw_traj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_system</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">stateB_traj</span> <span class="o">=</span> <span class="n">systemB</span><span class="o">.</span><span class="n">trajectory</span>

<span class="c1">#visualize</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">oneD_simulation_analysis_plot</span><span class="p">(</span><span class="n">systemB</span><span class="p">,</span> <span class="n">limits_coordinate_space</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 4906.14it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 127.16it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_14_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_14_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_14_2.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_14_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">ensembler</span> <span class="kn">import</span> <span class="n">visualisation</span>

<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">visualisation</span><span class="o">.</span><span class="n">figsize_doubleColumn</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">ax</span><span class="p">])</span>
<span class="n">traj_pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">systemA</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">systemA</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state A&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ene</span> <span class="o">=</span> <span class="n">systemA</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_pos</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">traj_pos</span><span class="p">,</span> <span class="n">ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;simulation state A&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>

<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">traj_pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">systemB</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">systemB</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state B&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ene</span> <span class="o">=</span> <span class="n">systemB</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_pos</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">traj_pos</span><span class="p">,</span> <span class="n">ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;simulation state B&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$V/[kT]$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;single state simulations&quot;</span><span class="p">)</span>
<span class="c1">#fig.savefig(&quot;freeEnergyPertubation.pdf&quot;)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;single state simulations&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_15_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_15_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Sampling l1</span>
<span class="n">V11</span><span class="o">=</span><span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateA_traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">V21</span><span class="o">=</span><span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateA_traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

<span class="c1">#Sampling l2</span>
<span class="n">V12</span><span class="o">=</span><span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateB_traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">V22</span><span class="o">=</span><span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateB_traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

<span class="n">bar</span> <span class="o">=</span> <span class="n">bennetAcceptanceRatio</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convergence_radius</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">dF_AB_bar</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">Vj_i</span><span class="o">=</span><span class="n">V21</span><span class="p">,</span> <span class="n">Vi_i</span><span class="o">=</span><span class="n">V11</span><span class="p">,</span> <span class="n">Vi_j</span><span class="o">=</span><span class="n">V12</span><span class="p">,</span> <span class="n">Vj_j</span><span class="o">=</span><span class="n">V22</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_expected</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BAR Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_bar</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Difference:&quot;</span><span class="p">,</span> <span class="n">dF_AB_bar</span> <span class="o">-</span> <span class="n">dF_AB_expected</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iterate:        convergence raidus: 0.01
Iteration: 0    dF: 5.312159617709778   convergence 5.312159617709778
Iteration: 1    dF: 6.30192824866377    convergence 0.9897686309539919
Iteration: 2    dF: 6.843891407476693   convergence 0.5419631588129228
Iteration: 3    dF: 7.143907240693938   convergence 0.30001583321724556
Iteration: 4    dF: 7.311132130071263   convergence 0.16722488937732471
Iteration: 5    dF: 7.4051820596147255  convergence 0.0940499295434627
Iteration: 6    dF: 7.45844778962537    convergence 0.053265730010644496
Iteration: 7    dF: 7.488752609194908   convergence 0.030304819569537678
Iteration: 8    dF: 7.506041889052739   convergence 0.01728927985783102
Iteration: 9    dF: 7.515921769607192   convergence 0.009879880554453102

Final Iterations:  9  Result:  7.515921769607192

Expected Result:  1.2746530721670273
BAR Result:  7.515921769607192

Difference: 6.241268697440164
</pre></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="Coupling-Methods">
<h2>Coupling Methods<a class="headerlink" href="#Coupling-Methods" title="Permalink to this headline">¶</a></h2>
<p>If the phase space overlap of the two state is low, the free energy estimate might deviate a lot from the real result. This issue can be solved by coupling the phase space of the two states in a simulation. Two ways of coupling will be discussed. The first one is <span class="math notranslate nohighlight">\(\lambda\)</span>-coupling which forms a linear combination of the two states, this is used for EXP and TI. Second there is the exponential boltzmann coupling used in enveloping distribution sampling (EDS).</p>
<div class="section" id="\lambda---Coupling">
<h3><span class="math notranslate nohighlight">\(\lambda\)</span> - Coupling<a class="headerlink" href="#\lambda---Coupling" title="Permalink to this headline">¶</a></h3>
<p>One way of coupling two states is to generate the linear combination of the hamiltonians and coupling them by a variable <span class="math notranslate nohighlight">\(\lambda\)</span>. A <span class="math notranslate nohighlight">\(\lambda=0\)</span> corresponds here to state A and a <span class="math notranslate nohighlight">\(\lambda=1\)</span> corresponds to state B. The equal mixutre is gained with <span class="math notranslate nohighlight">\(\lambda=0.5\)</span>. All other lambda values in between <span class="math notranslate nohighlight">\([0,1]\)</span> result in intermediate states, that can be used to bridge the two states phase space. In the following we are going to build 10 lambda windows linearly distributed
from 0 to 1. These will be used for simulations, that are finally analyzed by Zwanzig (resulting in EXP/Free energy pertubation (FEP) method) or thermodynamic integration (TI).</p>
<p>Functional:</p>
<p><span class="math notranslate nohighlight">\(H_{\lambda} = (1-\lambda) H_A + \lambda H_B\)</span></p>
</div>
<div class="section" id="Build-System">
<h3>Build System<a class="headerlink" href="#Build-System" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Build Potential</span>
<span class="n">V_perturbed</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">linearCoupledPotentials</span><span class="p">(</span><span class="n">Va</span><span class="o">=</span><span class="n">V_A</span><span class="p">,</span> <span class="n">Vb</span><span class="o">=</span><span class="n">V_B</span><span class="p">)</span>

<span class="c1">#Visualize</span>
<span class="n">lambda_points</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">lambda_windows</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">lambda_points</span><span class="p">)</span>

<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="n">lambda_windows</span><span class="p">:</span>
    <span class="n">V_perturbed</span><span class="o">.</span><span class="n">set_lambda</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
    <span class="n">ene</span> <span class="o">=</span>  <span class="n">V_perturbed</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">ene</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;lam_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;V[kT]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sampled Potentials&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Sampled Potentials&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_19_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_19_1.png" />
</div>
</div>
</div>
<div class="section" id="id1">
<h3>Sampling<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>let’s run simulations for all generated intermediate states:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">perturbed_system</span> <span class="o">=</span> <span class="n">perturbedSystem</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">V_perturbed</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

<span class="n">system_trajs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="n">lambda_windows</span><span class="p">:</span>
    <span class="n">perturbed_system</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span><span class="n">lam</span>
    <span class="n">perturbed_system</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">withdraw_traj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_system</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">system_trajs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lam</span><span class="p">:</span> <span class="n">perturbed_system</span><span class="o">.</span><span class="n">trajectory</span><span class="p">})</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 4857.55it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 4278.29it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 5882.37it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 3296.84it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 3118.67it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 3328.36it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 3568.86it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 2373.36it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 2552.04it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 2969.44it/s]
</pre></div></div>
</div>
</div>
<div class="section" id="id2">
<h3>Analysis<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Sampling first we check the sampling</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">ensembler</span> <span class="kn">import</span> <span class="n">visualisation</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="c1">#Visualize</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">visualisation</span><span class="o">.</span><span class="n">figsize_doubleColumn</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">axes</span><span class="p">])</span>
<span class="n">enes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_lams</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">system_trajs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

<span class="k">for</span> <span class="n">lamI</span> <span class="ow">in</span> <span class="n">all_lams</span><span class="p">:</span>
    <span class="n">trajI</span> <span class="o">=</span> <span class="n">system_trajs</span><span class="p">[</span><span class="n">lamI</span><span class="p">]</span>
    <span class="n">V_perturbed</span><span class="o">.</span><span class="n">set_lambda</span><span class="p">(</span><span class="n">lamI</span><span class="p">)</span>
    <span class="n">ene</span> <span class="o">=</span>  <span class="n">V_perturbed</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">enes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ene</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">lamI</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">)(</span><span class="n">lamI</span><span class="o">+</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">trajI</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">V_perturbed</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">trajI</span><span class="o">.</span><span class="n">position</span><span class="p">),</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\lambda=$&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">lamI</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),)</span><span class="c1">#c=&quot;orange&quot;)</span>

<span class="n">logExp</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">enes</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_range</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V[kT]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;$\lambda$-intermediate states&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(-5, 6)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_23_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_23_1.png" />
</div>
</div>
</div>
<div class="section" id="EXP/FEP-with-multiple-lambda-windows:">
<h3>EXP/FEP with multiple lambda windows:<a class="headerlink" href="#EXP/FEP-with-multiple-lambda-windows:" title="Permalink to this headline">¶</a></h3>
<p>This method is calculating the energy difference between the different <span class="math notranslate nohighlight">\(\lambda\)</span>-points using the Zwanzig equation leading to a path from state A to state B.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dA_i_fw</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">zwanz</span> <span class="o">=</span> <span class="n">zwanzigEquation</span><span class="p">()</span>
<span class="n">all_lams</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">system_trajs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
<span class="k">for</span> <span class="n">lamI</span><span class="p">,</span> <span class="n">lamJ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_lams</span><span class="p">,</span> <span class="n">all_lams</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">trajI</span> <span class="o">=</span> <span class="n">system_trajs</span><span class="p">[</span><span class="n">lamI</span><span class="p">]</span>
    <span class="n">trajJ</span> <span class="o">=</span> <span class="n">system_trajs</span><span class="p">[</span><span class="n">lamJ</span><span class="p">]</span>

    <span class="n">Vi_fw</span> <span class="o">=</span> <span class="n">trajI</span><span class="o">.</span><span class="n">total_potential_energy</span>
    <span class="n">Vj_fw</span> <span class="o">=</span> <span class="n">trajJ</span><span class="o">.</span><span class="n">total_potential_energy</span>


    <span class="n">dF_zwanzig_fw</span> <span class="o">=</span> <span class="n">zwanz</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">Vi</span><span class="o">=</span><span class="n">Vi_fw</span><span class="p">,</span> <span class="n">Vj</span><span class="o">=</span><span class="n">Vj_fw</span><span class="p">)</span>

    <span class="n">dA_i_fw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dF_zwanzig_fw</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">visualisation</span><span class="o">.</span><span class="n">figsize_doubleColumn</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dA_i_fw</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$dFper lambda [kT]$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;dF per lambda point&quot;</span><span class="p">)</span>

<span class="n">dF_AB_FEP_10lambda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dA_i_fw</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_expected</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sum of intermediates Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_FEP_10lambda</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Difference:&quot;</span><span class="p">,</span> <span class="n">dF_AB_FEP_10lambda</span> <span class="o">-</span> <span class="n">dF_AB_expected</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Expected Result:  1.2746530721670273
Sum of intermediates Result:  0.7509801133760812

Difference: -0.5236729587909461
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_25_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_25_1.png" />
</div>
</div>
<div class="section" id="Thermodynamic-Integration-(TI)">
<h4>Thermodynamic Integration (TI)<a class="headerlink" href="#Thermodynamic-Integration-(TI)" title="Permalink to this headline">¶</a></h4>
<p>TI calculates the partial derivative <span class="math notranslate nohighlight">\(\langle \frac{\partial H}{\partial \lambda} \rangle_\lambda\)</span> for each <span class="math notranslate nohighlight">\(\lambda\)</span>-intermediate state and finally integrates over all intermediat states to retain the final free energy difference.</p>
<p><span class="math notranslate nohighlight">\(\int_0^1\langle \frac{\partial H}{\partial \lambda} \rangle_{\lambda} d\lambda\)</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">visualisation</span><span class="o">.</span><span class="n">figsize_doubleColumn</span><span class="p">)</span>

<span class="n">lam_stats</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">lam</span> <span class="ow">in</span> <span class="n">system_trajs</span><span class="p">:</span>
    <span class="n">lam_mean</span><span class="p">,</span> <span class="n">lam_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">system_trajs</span><span class="p">[</span><span class="n">lam</span><span class="p">]</span><span class="o">.</span><span class="n">dhdlam</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">system_trajs</span><span class="p">[</span><span class="n">lam</span><span class="p">]</span><span class="o">.</span><span class="n">dhdlam</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:])</span>
    <span class="n">lam_stats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lam</span><span class="p">:{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span><span class="n">lam_mean</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">lam_std</span><span class="p">}})</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">lam_mean</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">lam_mean</span><span class="p">,</span> <span class="n">lam_std</span><span class="p">)</span>

<span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">lam_stats</span><span class="p">),</span> <span class="p">[</span><span class="n">lam_stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lam_stats</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$dH/d\lambda$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;$dH/d\lambda$ for each Lambda point&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0.98, &#39;$dH/d\\lambda$ for each Lambda point&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_27_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_27_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>

<span class="n">lam</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">lam_stats</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">lam_stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lam</span><span class="p">]</span>
<span class="n">stds</span> <span class="o">=</span> <span class="p">[</span><span class="n">lam_stats</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lam</span><span class="p">]</span>

<span class="n">dF_AB_TI_trapez</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lam</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">means</span><span class="p">)</span>
<span class="n">dF_AB_TI_trapez_err</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lam</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">stds</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_expected</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trapez Rule Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_TI_trapez</span><span class="p">,</span> <span class="s2">&quot;+-&quot;</span><span class="p">,</span> <span class="n">dF_AB_TI_trapez_err</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Difference:&quot;</span><span class="p">,</span> <span class="n">dF_AB_TI_trapez</span> <span class="o">-</span> <span class="n">dF_AB_expected</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Expected Result:  1.2746530721670273
trapez Rule Result:  1.5341099931896047 +- 3.4204416170439425

Difference: 0.25945692102257745
</pre></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="State-Coupled---Enveloping-Distribution-Sampling-(EDS)">
<h2>State Coupled - Enveloping Distribution Sampling (EDS)<a class="headerlink" href="#State-Coupled---Enveloping-Distribution-Sampling-(EDS)" title="Permalink to this headline">¶</a></h2>
<p>EDS is combining the two physical states into one artificial reference state.</p>
<p><span class="math notranslate nohighlight">\(V_R = -\frac{1}{\beta s} \ln{(e^{-\beta s (V_A-E_A^R)}+e^{-\beta s (V_B-E_B^R)})}\)</span>,</p>
<p>with <span class="math notranslate nohighlight">\(s\)</span> as the smoothing parameter, <span class="math notranslate nohighlight">\(E_X^R\)</span> as the energy offset vector, and <span class="math notranslate nohighlight">\(\beta = \frac{1}{k_B T}\)</span> with <span class="math notranslate nohighlight">\(k_B\)</span> as Boltzmann constant and <span class="math notranslate nohighlight">\(T\)</span> as temperature.</p>
<p>the <span class="math notranslate nohighlight">\(s\)</span> parameter is used to smooth the barriers of reference state and the <span class="math notranslate nohighlight">\(E_X^R\)</span> vector is used to align the two states in the reference state to each other. Both parameters are crucial for enabling the sampling of all states during a simulation over the reference state.</p>
<p>For more info see the Example_EDS jupyter notebook.</p>
<div class="section" id="id3">
<h3>Build System<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Build Potential</span>
<span class="n">s</span><span class="o">=</span><span class="mi">1</span>
<span class="n">Eoff</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">V_eds</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">envelopedPotential</span><span class="p">(</span><span class="n">V_is</span><span class="o">=</span><span class="p">[</span><span class="n">V_A</span><span class="p">,</span><span class="n">V_B</span><span class="p">]</span> <span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">eoff</span><span class="o">=</span><span class="n">Eoff</span><span class="p">)</span>
<span class="n">s_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="c1">#Visualize</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_values</span><span class="p">:</span>
    <span class="n">V_eds</span><span class="o">.</span><span class="n">s</span><span class="o">=</span><span class="n">s</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_eds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_r=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state A&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state B&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="n">V_eds</span><span class="o">.</span><span class="n">s</span><span class="o">=</span><span class="mf">0.3</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;V[kT]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sampled Potentials&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Sampled Potentials&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_30_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_30_1.png" />
</div>
</div>
</div>
<div class="section" id="id4">
<h3>Sampling<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>The reference state is sampled here with Metropolis-Monte-Carlo algorithm, and at an feasible s-value, which was found by try and error.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">good_s_value</span><span class="o">=</span><span class="mf">0.3</span>
<span class="n">eds_system</span> <span class="o">=</span> <span class="n">edsSystem</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">V_eds</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">eds_s</span><span class="o">=</span><span class="n">good_s_value</span><span class="p">,</span> <span class="n">eds_Eoff</span><span class="o">=</span><span class="n">Eoff</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

<span class="n">eds_system</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">withdraw_traj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_system</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">eds_traj</span> <span class="o">=</span> <span class="n">eds_system</span><span class="o">.</span><span class="n">trajectory</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 1829.57it/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">traj</span> <span class="o">=</span> <span class="n">eds_traj</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">V_A_ene</span> <span class="o">=</span> <span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">V_B_ene</span> <span class="o">=</span> <span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">V_eds</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">]</span>
<span class="n">eds_ene</span> <span class="o">=</span> <span class="n">V_eds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

<span class="n">traj_pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">traj_ene</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">visualisation</span><span class="o">.</span><span class="n">figsize_doubleColumn</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">ax</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">V_A_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state A&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">,)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">V_B_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state B&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">eds_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference state&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">traj_pos</span><span class="p">,</span> <span class="n">traj_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;simulation reference state&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$V/[kT]$&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;EDS&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;EDS&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_33_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_33_1.png" />
</div>
</div>
</div>
<div class="section" id="id5">
<h3>Analysis<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>In the next step we are going to calculate the free energy from the EDS-simulation.</p>
<div class="section" id="Zwanzig-EDS_Evaluation">
<h4>Zwanzig-EDS_Evaluation<a class="headerlink" href="#Zwanzig-EDS_Evaluation" title="Permalink to this headline">¶</a></h4>
<p>In EDS the relative free energy can be calculated using the Zwanzig equation along the Path of state A-&gt; state R -&gt; state B. As result the free energy difference can be estimated from only one simulation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rew_zwanz</span> <span class="o">=</span> <span class="n">threeStateZwanzig</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">traj_positions</span> <span class="o">=</span> <span class="n">eds_traj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">Vrr</span> <span class="o">=</span> <span class="n">eds_traj</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">VAr</span> <span class="o">=</span> <span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_positions</span><span class="p">)</span>
<span class="n">VBr</span> <span class="o">=</span> <span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_positions</span><span class="p">)</span>

<span class="n">dF_AB_EDS</span> <span class="o">=</span> <span class="n">rew_zwanz</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">Vi</span><span class="o">=</span><span class="n">VAr</span><span class="p">,</span> <span class="n">Vj</span><span class="o">=</span><span class="n">VBr</span><span class="p">,</span> <span class="n">Vr</span><span class="o">=</span><span class="n">Vrr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dF &quot;</span><span class="p">,</span> <span class="n">dF_AB_EDS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;deviation: &quot;</span><span class="p">,</span> <span class="n">dF_AB_EDS</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dF  2.3366227041357663
deviation:  1.061969631968739
</pre></div></div>
</div>
</div>
<div class="section" id="BAR-EDS_Evaluation">
<h4>BAR-EDS_Evaluation<a class="headerlink" href="#BAR-EDS_Evaluation" title="Permalink to this headline">¶</a></h4>
<p>Alternativly also BAR can be applied to calculate the free energy difference. The only requirement is to have two additional simulations of the two pure physical state, like we used in our first approaches.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">traj_positions</span> <span class="o">=</span> <span class="n">eds_traj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>

<span class="c1">#Sampling l1</span>
<span class="n">V11</span><span class="o">=</span><span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateA_traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">V21</span><span class="o">=</span><span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateA_traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">Vr1</span> <span class="o">=</span> <span class="n">V_eds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">stateA_traj</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>

<span class="c1">#Sampling l2</span>
<span class="n">V12</span><span class="o">=</span><span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateB_traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">V22</span><span class="o">=</span><span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">stateB_traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">Vr2</span> <span class="o">=</span> <span class="n">V_eds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">stateB_traj</span><span class="o">.</span><span class="n">position</span><span class="p">))</span>

<span class="n">Vrr</span> <span class="o">=</span> <span class="n">eds_traj</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">V1r</span> <span class="o">=</span> <span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_positions</span><span class="p">)</span>
<span class="n">V2r</span> <span class="o">=</span> <span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_positions</span><span class="p">)</span>

<span class="n">bar</span> <span class="o">=</span> <span class="n">bennetAcceptanceRatio</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="c1">#State 1 -&gt; State R</span>
<span class="n">df_AB_BAR_1R</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">Vj_i</span><span class="o">=</span><span class="n">Vr1</span><span class="p">,</span> <span class="n">Vi_i</span><span class="o">=</span><span class="n">V11</span><span class="p">,</span> <span class="n">Vi_j</span><span class="o">=</span><span class="n">V1r</span><span class="p">,</span> <span class="n">Vj_j</span><span class="o">=</span><span class="n">Vrr</span><span class="p">,</span> <span class="p">)</span>
<span class="c1">#State R -&gt; State 2</span>
<span class="n">df_AB_BAR_R2</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">Vj_i</span><span class="o">=</span><span class="n">V2r</span><span class="p">,</span> <span class="n">Vi_i</span><span class="o">=</span><span class="n">Vrr</span><span class="p">,</span> <span class="n">Vi_j</span><span class="o">=</span><span class="n">Vr2</span><span class="p">,</span> <span class="n">Vj_j</span><span class="o">=</span><span class="n">V22</span><span class="p">)</span>
<span class="c1">#State 1 -&gt; State 2</span>
<span class="n">dF_AB_EDS_bar</span> <span class="o">=</span> <span class="n">df_AB_BAR_1R</span><span class="o">+</span><span class="n">df_AB_BAR_R2</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1R&quot;</span><span class="p">,</span> <span class="n">df_AB_BAR_1R</span><span class="p">,</span> <span class="s2">&quot;2R&quot;</span><span class="p">,</span> <span class="n">df_AB_BAR_R2</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dF_BAR:  &quot;</span><span class="p">,</span> <span class="n">dF_AB_EDS_bar</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;deviation: &quot;</span><span class="p">,</span> <span class="n">dF_AB_EDS_bar</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">)</span>




</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Final Iterations:  5  Result:  -0.5167721401556298

Final Iterations:  5  Result:  2.735161926331498
1R -0.5167721401556298 2R 2.735161926331498
dF_BAR:   2.218389786175868
deviation:  0.9437367140088408
</pre></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="Hybrid-Methods---\lambda-EDS">
<h2>Hybrid Methods - <span class="math notranslate nohighlight">\(\lambda\)</span>-EDS<a class="headerlink" href="#Hybrid-Methods---\lambda-EDS" title="Permalink to this headline">¶</a></h2>
<p>As generalization of EDS and the <span class="math notranslate nohighlight">\(\lambda\)</span>-coupling <span class="math notranslate nohighlight">\(\lambda\)</span>-EDS was defined. It combines both methods and behaves like EDS with <span class="math notranslate nohighlight">\(\lambda=0.5\)</span> and represents state A with <span class="math notranslate nohighlight">\(\lambda = 0\)</span> and state B with <span class="math notranslate nohighlight">\(\lambda = 1\)</span>. Additionally the EDS parameters can be used for modifying the potentials.</p>
<div class="section" id="id6">
<h3>Build System<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Build Potential</span>
<span class="n">s</span><span class="o">=</span><span class="mi">1</span>
<span class="n">Eoff</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">V_hleds</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">lambdaEDSPotential</span><span class="p">(</span><span class="n">V_is</span><span class="o">=</span><span class="p">[</span><span class="n">V_A</span><span class="p">,</span><span class="n">V_B</span><span class="p">]</span> <span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">s_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="c1">#Visualize</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>

<span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_values</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">V_hleds</span><span class="o">.</span><span class="n">s</span><span class="o">=</span><span class="n">s</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_hleds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$V_r=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state A&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state B&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;V[kT]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sampled Potentials&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0        100.0
1        1.0
2        0.5
3        0.3
4        0.2
5        0.1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Sampled Potentials&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_39_2.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_39_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">14</span><span class="p">])</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
<span class="n">s_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>
<span class="n">lams</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">7</span><span class="p">))))</span>


<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">s_values</span><span class="p">):</span>
    <span class="n">V_hleds</span><span class="o">.</span><span class="n">s</span><span class="o">=</span> <span class="n">s</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">lam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lams</span><span class="p">):</span>
        <span class="n">V_hleds</span><span class="o">.</span><span class="n">lam</span><span class="o">=</span><span class="n">lam</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_hleds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\lambda=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V[kT]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;s = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_40_0.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_40_0.png" />
</div>
</div>
</div>
<div class="section" id="Simulate">
<h3>Simulate<a class="headerlink" href="#Simulate" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hleds_system</span> <span class="o">=</span> <span class="n">edsSystem</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">V_hleds</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">eds_Eoff</span><span class="o">=</span><span class="n">Eoff</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

<span class="n">hleds_simulation_trajs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">good_s_value</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">hleds_system</span><span class="o">.</span><span class="n">set_s</span><span class="p">(</span><span class="n">good_s_value</span><span class="p">)</span>
<span class="n">hleds_system</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">hleds_system</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">withdraw_traj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_system</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hleds_simulation_traj</span> <span class="o">=</span> <span class="n">hleds_system</span><span class="o">.</span><span class="n">trajectory</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Simulation:  Simulation: 100%|██████████| 100/100 [00:00&lt;00:00, 1790.37it/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Simulation at other lambdas</span>

<span class="n">hleds_system</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">hleds_system</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">withdraw_traj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_system</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hleds_simulation_traj2</span> <span class="o">=</span> <span class="n">hleds_system</span><span class="o">.</span><span class="n">trajectory</span>


<span class="n">hleds_system</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">hleds_system</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">withdraw_traj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_system</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hleds_simulation_traj3</span> <span class="o">=</span> <span class="n">hleds_system</span><span class="o">.</span><span class="n">trajectory</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Simulation:  Simulation: 100%|██████████| 100/100 [00:02&lt;00:00, 40.96it/s]
Simulation:  Simulation: 100%|██████████| 100/100 [00:02&lt;00:00, 37.42it/s]
</pre></div></div>
</div>
</div>
<div class="section" id="id7">
<h3>Analysis<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>checkout the sampling</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">traj</span> <span class="o">=</span> <span class="n">hleds_simulation_traj</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">traj2</span> <span class="o">=</span> <span class="n">hleds_simulation_traj2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">traj3</span> <span class="o">=</span> <span class="n">hleds_simulation_traj3</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>

<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">V_A_ene</span> <span class="o">=</span> <span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">V_B_ene</span> <span class="o">=</span> <span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">V_hleds</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">]</span>

<span class="n">V_hleds</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">eds_ene</span> <span class="o">=</span> <span class="n">V_hleds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">V_hleds</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">eds_ene1</span> <span class="o">=</span> <span class="n">V_hleds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">V_hleds</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">eds_ene2</span> <span class="o">=</span> <span class="n">V_hleds</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

<span class="n">traj_pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">traj_ene</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">)</span>
<span class="n">traj_pos2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj2</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">traj_ene2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj2</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">)</span>
<span class="n">traj_pos3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj3</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
<span class="n">traj_ene3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj3</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">visualisation</span><span class="o">.</span><span class="n">figsize_doubleColumn</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">ax</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">V_A_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state A&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">,)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">V_B_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state B&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">eds_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference state, $\lambda$=0.5&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">eds_ene1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference state, $\lambda$=0.25&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">eds_ene2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference state, $\lambda$=0.75&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">traj_pos</span><span class="p">,</span> <span class="n">traj_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;simulation reference state&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">traj_pos2</span><span class="p">,</span> <span class="n">traj_ene2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;simulation reference state&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">traj_pos3</span><span class="p">,</span> <span class="n">traj_ene3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;simulation reference state&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$V/[kT]$&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;$\lambda$-EDS&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;$\\lambda$-EDS&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_45_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_45_1.png" />
</div>
</div>
<p>many different free energy calculation methods can by used with <span class="math notranslate nohighlight">\(\lambda\)</span>-EDS and a certain sampling strategy. Here we chose the same as for EDS, which should result in a similar free energy difference.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rew_zwanz</span> <span class="o">=</span> <span class="n">threeStateZwanzig</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">zwanz</span> <span class="o">=</span> <span class="n">zwanzigEquation</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">traj_positions</span> <span class="o">=</span> <span class="n">hleds_simulation_traj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">Vr</span> <span class="o">=</span> <span class="n">hleds_simulation_traj</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
<span class="n">V1</span> <span class="o">=</span> <span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_positions</span><span class="p">)</span>
<span class="n">V2</span> <span class="o">=</span> <span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_positions</span><span class="p">)</span>

<span class="n">dF_AB_leds</span> <span class="o">=</span> <span class="n">rew_zwanz</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">Vi</span><span class="o">=</span><span class="n">V1</span><span class="p">,</span> <span class="n">Vj</span><span class="o">=</span><span class="n">V2</span><span class="p">,</span> <span class="n">Vr</span><span class="o">=</span><span class="n">Vr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dF &quot;</span><span class="p">,</span> <span class="n">dF_AB_leds</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;deviation: &quot;</span><span class="p">,</span> <span class="n">dF_AB_leds</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">)</span>


</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dF  1.864237147514947
deviation:  0.5895840753479198
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Enhanced-Sampling-with-system-Coupling">
<h2>Enhanced Sampling with system Coupling<a class="headerlink" href="#Enhanced-Sampling-with-system-Coupling" title="Permalink to this headline">¶</a></h2>
<p>Enhanced Sampling is a category for methods, that speed up the sampling of a phase space. These methods can be of course combined with free energy.</p>
<p>Here we are going to show two methods, that are: * Conveyor Belt TI - a method using a variable <span class="math notranslate nohighlight">\(\lambda\)</span>-coupling approach (~<span class="math notranslate nohighlight">\(\lambda\)</span>-dynamics) * RE-EDS - a combination of hamiltonian replica exchange (HRE) and EDS</p>
<p>Not covered: * <span class="math notranslate nohighlight">\(\lambda\)</span> - HRE-FEP</p>
<div class="section" id="Conveyor-Belt-TI">
<h3>Conveyor Belt TI<a class="headerlink" href="#Conveyor-Belt-TI" title="Permalink to this headline">¶</a></h3>
<p>The conveyor belt TI (CVB-TI) is using a similar building on <span class="math notranslate nohighlight">\(\lambda\)</span>-dynamics, which allows to run simulations with a changable <span class="math notranslate nohighlight">\(\lambda\)</span>-parameter. In CVB-TI multiple replicas are placed onto a conveyor belt, that is accelerated by the derivates of the hamiltonians of each replicas by the <span class="math notranslate nohighlight">\(\lambda\)</span>-parameter. This allows for all replicas to sample areas of the <span class="math notranslate nohighlight">\(\lambda\)</span>-space or even full rotations of the conveyor belt.</p>
<div class="section" id="id8">
<h4>Build System<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">num_replicas</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">trials</span> <span class="o">=</span> <span class="n">simulation_steps_total_per_approach</span>

<span class="n">V_perturbed</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">linearCoupledPotentials</span><span class="p">(</span><span class="n">Va</span><span class="o">=</span><span class="n">V_A</span><span class="p">,</span> <span class="n">Vb</span><span class="o">=</span><span class="n">V_B</span><span class="p">)</span>
<span class="n">lam_system</span> <span class="o">=</span> <span class="n">perturbedSystem</span><span class="p">(</span><span class="n">potential</span><span class="o">=</span><span class="n">V_perturbed</span> <span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
<span class="n">conveyorBelt</span><span class="o">=</span><span class="n">cvb</span><span class="o">.</span><span class="n">conveyorBelt</span><span class="p">(</span><span class="n">capital_lambda</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">n_replicas</span><span class="o">=</span><span class="n">num_replicas</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">lam_system</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="id9">
<h4>Simulate<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>here we simulate the conveyorbelt. Every replica does nsteps_between_trials, till the next conveyorbelt rotation update.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">conveyorBelt</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>
<span class="n">cvb_trajs</span> <span class="o">=</span> <span class="n">conveyorBelt</span><span class="o">.</span><span class="n">get_trajectories</span><span class="p">()</span>


</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9e72e42f92d54f77ad9ef2e9d476939d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
</div>
<div class="section" id="id10">
<h4>Analysis<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<div class="section" id="Visualize-the-sampling-of-\lambda-space">
<h5>Visualize the sampling of <span class="math notranslate nohighlight">\(\lambda\)</span>-space<a class="headerlink" href="#Visualize-the-sampling-of-\lambda-space" title="Permalink to this headline">¶</a></h5>
<p>First all replica <span class="math notranslate nohighlight">\(\lambda\)</span>-trajectories are shown.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cvb_trajs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cvb_trajs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">lam</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\lambda_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>    <span class="n">axes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$time [steps]$&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Conveyor belt replica sampling&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_54_0.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_54_0.png" />
</div>
</div>
<p>A histogram of the conveyor belt capital <span class="math notranslate nohighlight">\(\lambda\)</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">nbins</span><span class="o">=</span><span class="mi">50</span>
<span class="n">mega_traj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:],</span> <span class="n">cvb_trajs</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>
<span class="n">p</span><span class="p">,</span> <span class="n">lam_bins</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mega_traj</span><span class="o">.</span><span class="n">lam</span><span class="p">))),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\lambda$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$p_</span><span class="si">{density}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Capital $\lambda$ histogramm&quot;</span><span class="p">)</span>
<span class="k">pass</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_56_0.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_56_0.png" />
</div>
</div>
</div>
<div class="section" id="Visualize-the-sampling-on-potential-energy-functions">
<h5>Visualize the sampling on potential energy functions<a class="headerlink" href="#Visualize-the-sampling-on-potential-energy-functions" title="Permalink to this headline">¶</a></h5>
<p>like before we can map the sampling, retained for the phase-space.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">mega_traj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cvb_trajs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">find_nearest_bin</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="n">cbins</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array</span><span class="o">-</span><span class="n">val</span><span class="p">))</span>
        <span class="n">cbins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cbins</span>

<span class="n">discrete_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">find_nearest_bin</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">mega_traj</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:],</span> <span class="n">array</span><span class="o">=</span><span class="n">lam_bins</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>
<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mega_traj</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]),</span> <span class="n">mega_traj</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="n">discrete_traj</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab20&quot;</span><span class="p">)</span>

<span class="c1">#State Potentials</span>
<span class="n">V_A</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">harmonicOscillatorPotential</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k1</span><span class="p">,</span> <span class="n">x_shift</span><span class="o">=</span><span class="n">xoff1</span><span class="p">,</span> <span class="n">y_shift</span><span class="o">=</span><span class="n">yoff1</span><span class="p">)</span>
<span class="n">V_B</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">harmonicOscillatorPotential</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k2</span><span class="p">,</span> <span class="n">x_shift</span><span class="o">=</span><span class="n">xoff2</span><span class="p">,</span> <span class="n">y_shift</span><span class="o">=</span><span class="n">yoff2</span><span class="p">)</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state1&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state2&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V[kT]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Conveyor Belt Sampling&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Conveyor Belt Sampling&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_58_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_58_1.png" />
</div>
</div>
</div>
<div class="section" id="Calculate-Free-Energy-with-TI">
<h5>Calculate Free-Energy with TI<a class="headerlink" href="#Calculate-Free-Energy-with-TI" title="Permalink to this headline">¶</a></h5>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>

<span class="n">lambda_stat</span> <span class="o">=</span> <span class="n">mega_traj</span><span class="p">[[</span><span class="s2">&quot;lam&quot;</span><span class="p">,</span><span class="s2">&quot;dhdlam&quot;</span><span class="p">]]</span>

<span class="n">means_cvb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lambda_stat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">discrete_traj</span><span class="o">==</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">dhdlam</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">std_cvb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lambda_stat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">discrete_traj</span><span class="o">==</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">dhdlam</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">means_cvb</span><span class="p">)</span>

<span class="n">dF_AB_cvb_trapez</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lam_bins</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">means_cvb</span><span class="p">)</span>
<span class="n">dF_AB_err</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">means_cvb</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">std_cvb</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_expected</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trapez Rule Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_cvb_trapez</span><span class="p">,</span> <span class="s2">&quot;+-&quot;</span><span class="p">,</span> <span class="n">dF_AB_err</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Difference:&quot;</span><span class="p">,</span> <span class="n">dF_AB_cvb_trapez</span> <span class="o">-</span> <span class="n">dF_AB_expected</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Expected Result:  1.2746530721670273
trapez Rule Result:  0.2406082990408867 +- 3.0451131643051697

Difference: -1.0340447731261406
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_60_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_60_1.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="RE-EDS">
<h3>RE-EDS<a class="headerlink" href="#RE-EDS" title="Permalink to this headline">¶</a></h3>
<p>Replica EDS is a combination of HRE and EDS. In the HRE the s-parameter is exchanged and therefore different levels of smoothing are sampled in one simulation approach. This helps with the s-parameter choice, as now a full distribution can be chosen.</p>
<div class="section" id="id11">
<h4>Build System<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#potential</span>
<span class="n">V_eds</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">envelopedPotential</span><span class="p">(</span><span class="n">V_is</span><span class="o">=</span><span class="p">[</span><span class="n">V_A</span><span class="p">,</span><span class="n">V_B</span><span class="p">])</span>

<span class="c1">##System</span>
<span class="n">eds_system</span> <span class="o">=</span> <span class="n">edsSystem</span><span class="p">(</span><span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">potential</span><span class="o">=</span><span class="n">V_eds</span><span class="p">,</span> <span class="n">start_position</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

<span class="c1">##Ensemble</span>
<span class="c1">##Ensemble Settings:</span>
<span class="n">number_of_replica</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">s_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">number_of_replica</span><span class="p">)</span>
<span class="n">steps_between_trials</span><span class="o">=</span> <span class="mi">20</span>
<span class="n">trials</span><span class="o">=</span><span class="n">simulation_steps_total_per_approach</span><span class="o">//</span><span class="n">steps_between_trials</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DO trials: &quot;</span><span class="p">,</span> <span class="n">trials</span><span class="p">,</span> <span class="s2">&quot;steps: &quot;</span><span class="p">,</span> <span class="n">steps_between_trials</span><span class="p">)</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">replica_exchange</span><span class="o">.</span><span class="n">replicaExchangeEnvelopingDistributionSampling</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">eds_system</span><span class="p">,</span> <span class="n">exchange_criterium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                          <span class="n">s_range</span><span class="o">=</span><span class="n">s_values</span><span class="p">,</span> <span class="n">steps_between_trials</span><span class="o">=</span><span class="n">steps_between_trials</span><span class="p">)</span>


<span class="c1">#Visualize</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>

<span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">replica</span> <span class="ow">in</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">replicas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">replica</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$replica &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>

<span class="n">V_eds</span><span class="o">.</span><span class="n">i</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_eds</span><span class="o">.</span><span class="n">V_is</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state1&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">V_eds</span><span class="o">.</span><span class="n">V_is</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;state2&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;V[kT]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sampled Potentials&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
DO trials:  5 steps:  20
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Sampled Potentials&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_62_2.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_62_2.png" />
</div>
</div>
</div>
<div class="section" id="id12">
<h4>Simulate<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">reset_ensemble</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">reeds_trajs</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">replica_trajectories</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Running trials: 100%|██████████| 100/100 [00:40&lt;00:00,  2.49it/s]
</pre></div></div>
</div>
</div>
<div class="section" id="id13">
<h4>Analysis<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">reeds_trajs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">V_A_ene</span> <span class="o">=</span> <span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">V_B_ene</span> <span class="o">=</span> <span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">V_A_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">,)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">V_B_ene</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

<span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span>  <span class="nb">round</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">replicas</span><span class="p">[</span><span class="n">traj</span><span class="p">]</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">replicas</span><span class="p">[</span><span class="n">traj</span><span class="p">]</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">min_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">reeds_trajs</span><span class="p">[</span><span class="n">traj</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:],</span> <span class="n">reeds_trajs</span><span class="p">[</span><span class="n">traj</span><span class="p">]</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:],</span> <span class="n">zorder</span><span class="o">=-</span><span class="n">traj</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">traj</span><span class="p">),</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;replica s=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$V/[kT]$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RE-EDS&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;RE-EDS&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_66_1.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_66_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trajs</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_trajectories</span><span class="p">()</span>

<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">trajs</span><span class="p">)</span><span class="o">//</span><span class="n">nrows</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>  <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">reeds_trajs</span><span class="p">,</span> <span class="n">axes</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">reeds_trajs</span><span class="p">[</span><span class="n">traj</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;replica&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">traj</span><span class="p">))</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ind</span><span class="o">%</span><span class="k">ncols</span> == 0): ax.set_ylabel(&quot;$p_{density}$&quot;)
    <span class="k">if</span><span class="p">(</span><span class="n">ind</span><span class="o">&gt;=</span><span class="p">(</span><span class="n">nrows</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">):</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$r$&quot;</span><span class="p">)</span>


<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_67_0.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_67_0.png" />
</div>
</div>
</div>
<div class="section" id="Visualization-of-Replica-Exchanges">
<h4>Visualization of Replica Exchanges<a class="headerlink" href="#Visualization-of-Replica-Exchanges" title="Permalink to this headline">¶</a></h4>
<p>here the Exchanges of the different replicas are shown.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">stats</span><span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">exchange_information</span>
<span class="n">replicas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">exchange_information</span><span class="o">.</span><span class="n">replicaID</span><span class="p">)</span>
<span class="n">trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">exchange_information</span><span class="o">.</span><span class="n">nExchange</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>

<span class="n">replica_positions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">replicas</span><span class="p">:</span>
    <span class="n">replica_positions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">replica</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">replicaID</span><span class="o">==</span><span class="n">replica</span><span class="p">]</span><span class="o">.</span><span class="n">replicaPositionI</span><span class="p">})</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">trials</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">replica_positions</span><span class="p">[</span><span class="n">replica</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;replica_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">replica</span><span class="p">))</span>

<span class="c1">#plt.yticks(replicas+1, reversed(replicas+1))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">replicas</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">replicas</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;replica Positions&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;trials&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Replica exchange transitions&quot;</span><span class="p">)</span>
<span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replicas</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">):</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/Examples_Example_FreeEnergyCalculationSimulation_69_0.png" src="../_images/Examples_Example_FreeEnergyCalculationSimulation_69_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">rew_zwanz</span> <span class="o">=</span> <span class="n">threeStateZwanzig</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">zwanz</span> <span class="o">=</span> <span class="n">zwanzigEquation</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">equilibration_steps</span><span class="o">=</span><span class="mi">10</span>
<span class="c1">#State Potentials</span>
<span class="n">V_A</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">harmonicOscillatorPotential</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k1</span><span class="p">,</span> <span class="n">x_shift</span><span class="o">=</span><span class="n">xoff1</span><span class="p">,</span> <span class="n">y_shift</span><span class="o">=</span><span class="n">yoff1</span><span class="p">)</span>
<span class="n">V_B</span> <span class="o">=</span> <span class="n">pot</span><span class="o">.</span><span class="n">harmonicOscillatorPotential</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k2</span><span class="p">,</span> <span class="n">x_shift</span><span class="o">=</span><span class="n">xoff2</span><span class="p">,</span> <span class="n">y_shift</span><span class="o">=</span><span class="n">yoff2</span><span class="p">)</span>

<span class="c1">#optimal sampling distribution</span>
<span class="n">opt_samp_fraction</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>

<span class="n">min_mae</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">min_mae_replica</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">dF_AB_RE_EDS_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">s_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reeds_trajs</span><span class="p">):</span>
    <span class="n">s_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reeds_trajs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">traj_positions</span> <span class="o">=</span> <span class="n">reeds_trajs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
    <span class="n">Vr</span> <span class="o">=</span> <span class="n">reeds_trajs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">total_potential_energy</span><span class="p">[</span><span class="n">equilibration_steps</span><span class="p">:]</span>
    <span class="n">V1</span> <span class="o">=</span> <span class="n">V_A</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_positions</span><span class="p">)</span>
    <span class="n">V2</span> <span class="o">=</span> <span class="n">V_B</span><span class="o">.</span><span class="n">ene</span><span class="p">(</span><span class="n">traj_positions</span><span class="p">)</span>

    <span class="c1">#dominant state sampling:</span>
    <span class="n">min_enes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">min_enes</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">norm_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">min_enes</span><span class="p">)</span>

    <span class="n">MAE_optimal_sampling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">norm_counts</span><span class="o">-</span><span class="n">opt_samp_fraction</span><span class="p">))</span>
    <span class="k">if</span><span class="p">(</span><span class="n">MAE_optimal_sampling</span><span class="o">&lt;</span><span class="n">min_mae</span><span class="p">):</span>
        <span class="n">min_mae</span> <span class="o">=</span> <span class="n">MAE_optimal_sampling</span>
        <span class="n">min_mae_replica</span> <span class="o">=</span> <span class="n">key</span>

    <span class="n">dF_AB_RE_EDS_zwanz</span> <span class="o">=</span> <span class="n">rew_zwanz</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">Vi</span><span class="o">=</span><span class="n">V1</span><span class="p">,</span> <span class="n">Vj</span><span class="o">=</span><span class="n">V2</span><span class="p">,</span> <span class="n">Vr</span><span class="o">=</span><span class="n">Vr</span><span class="p">)</span>
    <span class="n">dF_AB_RE_EDS_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dF_AB_RE_EDS_zwanz</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Expected Result: &quot;</span><span class="p">,</span> <span class="n">dF_AB_expected</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;s</span><span class="se">\t\t</span><span class="s2">dF</span><span class="se">\t\t</span><span class="s2">diff&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="nb">zip</span><span class="p">(</span><span class="n">s_vals</span><span class="p">,</span> <span class="n">dF_AB_RE_EDS_results</span><span class="p">,</span> <span class="n">dF_AB_RE_EDS_results</span> <span class="o">-</span> <span class="n">dF_AB_expected</span><span class="p">)])))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

        Expected Result:  1.2746530721670273
s               dF              diff
1.0             3.94409         2.66944
0.77426         6.85809         5.58344
0.59948         5.60009         4.32544
0.46416         3.17554         1.90089
0.35938         2.66814         1.39348
0.27826         1.05054         -0.22411
0.21544         0.17714         -1.09751
0.16681         -0.17674                -1.45139
0.12915         -0.07538                -1.35003
0.1             1.18102         -0.09363




</pre></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="Final-Results">
<h2>Final Results<a class="headerlink" href="#Final-Results" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">md_str</span> <span class="o">=</span> <span class="s2">&quot;| method | dF  | deviation |</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;|---|---|---|</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| analytical   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  |   | </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| Zwanzig   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_zwanzig</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_zwanzig</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| BAR   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_bar</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_bar</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| FEP 10-$\lambda$ Points   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_FEP_10lambda</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_FEP_10lambda</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| TI 10-$\lambda$ Points  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_TI_trapez</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_TI_trapez</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| EDS   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_EDS</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_EDS</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| EDS-BAR   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_EDS_bar</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_EDS_bar</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| $\lambda$ EDS   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_leds</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_leds</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| conveyor belt TI   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_cvb_trapez</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_cvb_trapez</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">md_str</span> <span class="o">+=</span> <span class="s2">&quot;| RE-DS   | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_RE_EDS_results</span><span class="p">[</span><span class="n">min_mae_replica</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;  | &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dF_AB_RE_EDS_results</span><span class="p">[</span><span class="n">min_mae_replica</span><span class="p">]</span><span class="o">-</span><span class="n">dF_AB_expected</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; | </span><span class="se">\n</span><span class="s2">&quot;</span>


<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">Latex</span>
<span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">md_str</span><span class="p">))</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<table class="docutils align-default">
<colgroup>
<col style="width: 67%" />
<col style="width: 12%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>method</p></th>
<th class="head"><p>dF</p></th>
<th class="head"><p>deviation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>analytical</p></td>
<td><p>1.27</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Zwanzig</p></td>
<td><p>-1.07</p></td>
<td><p>-2.34</p></td>
</tr>
<tr class="row-even"><td><p>BAR</p></td>
<td><p>7.52</p></td>
<td><p>6.24</p></td>
</tr>
<tr class="row-odd"><td><p>FEP 10-<span class="math notranslate nohighlight">\(\lambda\)</span> Points</p></td>
<td><p>0.75</p></td>
<td><p>-0.52</p></td>
</tr>
<tr class="row-even"><td><p>TI 10-<span class="math notranslate nohighlight">\(\lambda\)</span> Points</p></td>
<td><p>1.53</p></td>
<td><p>0.26</p></td>
</tr>
<tr class="row-odd"><td><p>EDS</p></td>
<td><p>2.34</p></td>
<td><p>1.06</p></td>
</tr>
<tr class="row-even"><td><p>EDS-BAR</p></td>
<td><p>2.22</p></td>
<td><p>0.94</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\lambda\)</span> EDS</p></td>
<td><p>1.86</p></td>
<td><p>0.59</p></td>
</tr>
<tr class="row-even"><td><p>conveyor belt TI</p></td>
<td><p>0.24</p></td>
<td><p>-1.03</p></td>
</tr>
<tr class="row-odd"><td><p>RE-DS</p></td>
<td><p>1.05</p></td>
<td><p>-0.22</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../_source/modules.html" class="btn btn-neutral float-right" title="Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Example_EnhancedSampling.html" class="btn btn-neutral float-left" title="Enhanced Sampling Simulations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Benjamin Ries, Stephanie Linker, David Hahn. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.3

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>